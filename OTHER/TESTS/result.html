<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Results</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js';
    import { getFirestore, doc, getDoc, collection, getDocs } from 'https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "onlinetestapp-ea2a0.firebaseapp.com",
      projectId: "onlinetestapp-ea2a0",
      storageBucket: "onlinetestapp-ea2a0.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const testId = localStorage.getItem("test_id");
    const userId = localStorage.getItem("user_id") || "demo_user";

    async function loadResults() {
      const testDocRef = doc(db, "tests", testId);
      const testSnap = await getDoc(testDocRef);

      if (testSnap.exists()) {
        const testData = testSnap.data();
        const correctAnswers = testData.correctAnswers || {};
        const resultsDocRef = doc(db, `results/${userId}_${testId}`);
        const resultsSnap = await getDoc(resultsDocRef);
        const questionSnapshot = await getDocs(collection(db, `tests/${testId}/questions`));

        if (resultsSnap.exists()) {
          const resultsData = resultsSnap.data();
          const userAnswers = resultsData.answers;

          let score = 0;
          let resultsHtml = '';
          let pdfContent = 'Test Results\n';

          let questionMap = {};
          questionSnapshot.forEach(qDoc => {
            questionMap[qDoc.id] = qDoc.data();
          });

          Object.keys(correctAnswers).forEach((qid, i) => {
            const correctAnswer = correctAnswers[qid];
            const userAnswer = userAnswers[qid] || "Not Answered";
            const isCorrect = userAnswer === correctAnswer;
            const question = questionMap[qid]?.question || qid;
            const options = questionMap[qid]?.options || [];

            if (isCorrect) score++;

            resultsHtml += `
              <div class="mb-4 p-4 border rounded-xl bg-gray-50">
                <p class="font-semibold">Q${i + 1}: ${question}</p>
                <ul class="mb-2">
                  ${options.map(opt => `<li class="ml-4">${opt}</li>`).join('')}
                </ul>
                <p><strong>Your Answer:</strong> ${userAnswer}</p>
                <p><strong>Correct Answer:</strong> ${correctAnswer}</p>
                <p class="${isCorrect ? 'text-green-500' : 'text-red-500'}">
                  ${isCorrect ? 'Correct' : 'Incorrect'}
                </p>
              </div>
            `;

            pdfContent += `Q${i + 1}: ${question}\nOptions: ${options.join(', ')}\nYour Answer: ${userAnswer}\nCorrect: ${correctAnswer}\n\n`;
          });

          const totalQuestions = Object.keys(correctAnswers).length;
          const percentage = ((score / totalQuestions) * 100).toFixed(2);

          document.getElementById('results').innerHTML = `
            <h1 class="text-3xl font-bold">Your Test Results</h1>
            <p class="mb-6 text-xl">Score: ${score} / ${totalQuestions} (${percentage}%)</p>
            <button id="download-pdf" class="mb-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">Download PDF</button>
            ${resultsHtml}
          `;

          document.getElementById("download-pdf").addEventListener("click", () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text(pdfContent, 10, 10);
            doc.save("test_results.pdf");
          });

        } else {
          alert("No results found for this test.");
        }
      } else {
        alert("Test data not found.");
      }
    }

    window.onload = loadResults;
  </script>
</head>
<body class="bg-white min-h-screen p-4">
  <div class="max-w-5xl mx-auto">
    <div id="results" class="mt-6"></div>
  </div>
</body>
</html>
