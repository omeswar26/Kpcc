<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>T Test</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js';
    import { getFirestore, collection, getDocs, doc, setDoc } from 'https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js';

    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyAjbvRBKxvUq4fBw3JwufoCmxTqSbK-kXs",
  authDomain: "onlinetestapp-ea2a0.firebaseapp.com",
  projectId: "onlinetestapp-ea2a0",
  storageBucket: "onlinetestapp-ea2a0.firebasestorage.app",
  messagingSenderId: "939169687087",
  appId: "1:939169687087:web:2fe2aa5fd541a6169408da",
  measurementId: "G-EQSWTZB768"
};

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const testId = localStorage.getItem("test_id");
    const userId = localStorage.getItem("user_id") || "demo_user";
    const questionsContainer = document.getElementById("questions-container");
    const timerDisplay = document.getElementById("timer");
    const statusList = document.getElementById("status-list");

    let userAnswers = {};
    let totalQuestions = 0;
    let timeLeft = 900; // 15 mins

    function updateTimer() {
      const min = Math.floor(timeLeft / 60);
      const sec = timeLeft % 60;
      timerDisplay.textContent = `Time Left: ${min}:${sec < 10 ? '0' : ''}${sec}`;
      if (timeLeft <= 0) submitTest();
      else timeLeft--;
    }

    setInterval(updateTimer, 1000);

    async function loadQuestions() {
      const querySnapshot = await getDocs(collection(db, `tests/${testId}/questions`));
      totalQuestions = querySnapshot.size;
      let index = 0;

      querySnapshot.forEach((docSnap) => {
        const data = docSnap.data();
        const qid = docSnap.id;

        // Sidebar status
        const stat = document.createElement("button");
        stat.textContent = index + 1;
        stat.className = "w-10 h-10 border rounded-full hover:bg-blue-100";
        stat.onclick = () => document.getElementById(`q${index}`).scrollIntoView({ behavior: 'smooth' });
        stat.id = `status-${index}`;
        statusList.appendChild(stat);

        // Question UI
        const qDiv = document.createElement("div");
        qDiv.id = `q${index}`;
        qDiv.className = "mb-6 p-4 border rounded-xl bg-gray-50";
        qDiv.innerHTML = `
          <p class="font-semibold mb-2">Q${index + 1}. ${data.question}</p>
          <div class="space-y-2">
            ${data.options.map((opt, i) => `
              <label class="block">
                <input type="radio" name="q${index}" value="${opt}" class="mr-2 option-radio" data-qid="${qid}" data-index="${index}">
                ${opt}
              </label>
            `).join('')}
          </div>
          <button class="mt-2 px-3 py-1 text-sm bg-yellow-300 rounded review-btn" data-index="${index}">Add for Review</button>
        `;
        questionsContainer.appendChild(qDiv);
        index++;
      });
    }

    document.addEventListener("change", (e) => {
      if (e.target.classList.contains("option-radio")) {
        const qid = e.target.dataset.qid;
        const index = e.target.dataset.index;
        userAnswers[qid] = e.target.value;
        document.getElementById(`status-${index}`).className = "w-10 h-10 rounded-full bg-green-300";
      }
    });

    document.addEventListener("click", (e) => {
      if (e.target.classList.contains("review-btn")) {
        const index = e.target.dataset.index;
        document.getElementById(`status-${index}`).className = "w-10 h-10 rounded-full bg-yellow-300";
      }
    });

    async function submitTest() {
      await setDoc(doc(db, `results/${userId}_${testId}`), {
        answers: userAnswers,
        submittedAt: new Date()
      });
      alert("Test submitted successfully!");
      window.location.href = "result.html";
    }

    document.getElementById("submit-btn").addEventListener("click", submitTest);
    loadQuestions();
  </script>
</head>
<body class="bg-white min-h-screen p-4">
  <div class="max-w-5xl mx-auto">
    <div class="flex justify-between items-center mb-4">
      <h1 class="text-3xl font-bold">T Test</h1>
      <div id="timer" class="text-lg font-medium text-red-500">Time Left: 15:00</div>
    </div>
    <div class="flex gap-6">
      <div class="w-3/4" id="questions-container"></div>
      <div class="w-1/4">
        <h2 class="text-xl font-semibold mb-2">Status</h2>
        <div id="status-list" class="grid grid-cols-5 gap-2"></div>
      </div>
    </div>
    <div class="text-center mt-10">
      <button id="submit-btn" class="bg-green-500 text-white py-2 px-6 rounded-xl hover:bg-green-600">Submit Test</button>
    </div>
  </div>
</body>
</html>
